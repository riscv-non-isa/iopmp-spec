[#SPS_EXT]
=== Secondary Permission Setting (SPS)

This extension provides a mechanism to reduce the consumption of IOPMP entries in systems where multiple requesters (RRIDs) require different access permissions to the same shared memory regions.

Motivation: In the baseline specification, if RRID 'A' requires Read-Write (RW) access to a region and RRID 'B' requires Read-Only (RO) access to the exact same address range, two separate IOPMP entries must be configured (typically in two different Memory Domains). This consumes valuable Entry Array resources simply to define duplicate address ranges with different permissions.

The SPS extension addresses this by adding a second layer of permission checking within the SRCMD Table. This allows a single, shared IOPMP entry to define the address region with a superset of permissions (e.g., both read and write permissions are allowed), while the additional permission registers restrict the permissions for each RRID individually. This allows multiple RRIDs to share a single Memory Domain and its corresponding entries, significantly conserving the total number of entries required.

The field `sps_en` in register `HWCFG2` <<#REG_EXT_HWCFG2,Hardware Configuration 2>> indicates if the IOPMP implements the SPS extension.

When the SPS extension is implemented, each SRCMD Table entry additionally defines permission registers: `SRCMD_R(_s_)`, `SRCMD_W(_s_)`, and `SRCMD_X(_s_)`, as well as `SRCMD_RH(_s_)`, `SRCMD_WH(_s_)`, and `SRCMD_XH(_s_)` if applicable. <<#REG_EXT_SRCMD_R,RRID _s_ Read Permission>>, <<#REG_EXT_SRCMD_W,RRID _s_ Write Permission>>, and <<#REG_EXT_SRCMD_X,RRID _s_ Instruction Fetch Permission>> describe the details of these registers.

Register `SRCMD_R(_s_)`, `SRCMD_W(_s_)`, and `SRCMD_X(_s_)` each has a single field, `SRCMD_R(_s_).md`, `SRCMD_W(_s_).md`, and `SRCMD_X(_s_).md`, respectively representing the read, write, and instruction fetch permissions of memory domain 0 to 30 for requester _s_.
Register `SRCMD_RH(_s_)`, `SRCMD_WH(_s_)`, `SRCMD_XH(_s_)` each has a single field, `SRCMD_RH(_s_).mdh`, `SRCMD_WH(_s_).mdh`, and `SRCMD_XH(_s_).mdh`, respectively representing the read, write, and instruction fetch permissions of memory domain 31 to 62 for requester _s_.
Register `SRCMD_RH(_s_)`, `SRCMD_WH(_s_)`, and `SRCMD_XH(_s_)` are implemented if `HWCFG0.md_num` > 31.

.An example block diagram of an IOPMP with the SPS extension. It illustrates the checking flow of an IOPMP with the SPS extension. The IOPMP first looks up the SRCMD Table according to the RRID carried by the incoming transaction to retrieve associated MD indexes and the corresponding permissions related to these MDs. By the MD indexes, the IOPMP looks up the MDCFG Table to get the belonging entry indexes. The final step checks the access right according to the above entry indexes and corresponding permissions.
ifdef::backend-pdf[]
image::./images/iopmp_unit_block_diagram_other_formats.png[]
endif::[]
ifndef::backend-pdf[]
image::../images/iopmp_unit_block_diagram_other_formats.png[]
endif::[]


The extension shares the same locks as `SRCMD_EN(_s_)` and `SRCMD_ENH(_s_)`. Setting lock to `SRCMD_EN(_s_).l` locks `SRCMD_R(_s_)`, `SRCMD_RH(_s_)`, `SRCMD_W(_s_)`, `SRCMD_WH(_s_)`, `SRCMD_X(_s_)`, and `SRCMD_XH(_s_)`.
`MDLCK.md[_m_]` locks `SRCMD_R(_s_).md[_m_]`, `SRCMD_W(_s_).md[_m_]`, and `SRCMD_X(_s_).md[_m_]` for all existing RRID _s_.
`MDLCKH.mdh[_m_]` also locks `SRCMD_RH(_s_).mdh[_m_]`, `SRCMD_WH(_s_).mdh[_m_]`, and `SRCMD_XH(_s_).mdh[_m_]` for all existing RRID _s_.
`SRCMD_R(_s_)`, `SRCMD_RH(_s_)`, `SRCMD_W(_s_)`, `SRCMD_WH(_s_)`, `SRCMD_X(_s_)`, and `SRCMD_XH(_s_)` can have prelocked bits fully or partially based on presets of `MDLCK.md`, `MDLCK.mdh`, and `SRCMD_EN.l`.

The extension has two sets of permission settings: one from IOPMP entry and the other from SPS registers (`SRCMD_R`/`SRCMD_W`/`SRCMD_X`/`SRCMD_RH`/`SRCMD_WH`/`SRCMD_XH`). A transaction is legal only if it is permitted by both the SRCMD Table (SPS) permission and the matching entry's permission. A transaction fails the SPS check if it violates either of the permission settings. That is, the extension can only be used to restrict the permissions defined on an entry, not grant new permissions.